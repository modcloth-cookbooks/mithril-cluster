# Dropped off by Chef recipe[mithril::cluster] <%= Time.now %>
description "Mithril Service"

start on filesystem or runlevel [2345]
stop on runlevel [!2345]

setuid mithril
umask 022

respawn
respawn limit 3 10
chdir /home/mithril
script
  /home/mithril/bin/mithril-server -a='<%= @server_address %>' \
    -amqp.uri='<%= @amqp_uri %>' \
    <% if @pg_enabled -%>
    -pg \
    -pg.uri=$(awk -F: '{ print "postgres://" $4 ":" $5 "@" $1 "/" $3 "?sslmode=disable"}' /home/mithril/.pgpass 2>/dev/null || echo '') \
    <% end -%>
    <% if @debug_enabled -%>
    -d \
    <% end -%>
    -p='<%= @pid_file %>'
end script
